<link rel="stylesheet" href="/css/search/playerPosition.css" />

<div class="playerEachPositionContainer">
    <div class="searchAndResultWrap">
        <div>
            <input
                type="text"
                id="playerSearchInput"
                placeholder="ì„ ìˆ˜ ê²€ìƒ‰(ì…ë ¥ì‹œ ìë™ ê²€ìƒ‰ ë©ë‹ˆë‹¤.)"
            />
            <ul id="playerSearchResult">
                <!-- <li class="player">ì„ ìˆ˜ë¥¼ ê²€ìƒ‰ í•´ì£¼ì„¸ìš”</li> -->
            </ul>
        </div>
    </div>
    <div class="selectPlayerWrap hide">
        <div class="selectPlayerBox">
            <div class="playerSelectTab">
                <div class="playerInfoBox">
                    <div class="playerPhontoPlace">
                        <div class="playerImgWrap">
                            <img src="" alt="" class="playerImg" loading="lazy" onerror="" />
                        </div>
                        <div class="playerInfo">
                            <img
                                src=""
                                alt=""
                                class="selectPlayerSeason"
                                loading="lazy"
                                onerror=""
                            />
                            <div class="selectPlayerName"></div>
                            <select class="playerPosition">
                                <option value="0">GK</option>
                                <option value="1">SW</option>
                                <option value="2">RWB</option>
                                <option value="3">RB</option>
                                <option value="4">RCB</option>
                                <option value="5">CB</option>
                                <option value="6">LCB</option>
                                <option value="7">LB</option>
                                <option value="8">LWB</option>
                                <option value="9">RDM</option>
                                <option value="10">CDM</option>
                                <option value="11">LDM</option>
                                <option value="12">RM</option>
                                <option value="13">RCM</option>
                                <option value="14">CM</option>
                                <option value="15">LCM</option>
                                <option value="16">LM</option>
                                <option value="17">RAM</option>
                                <option value="18">CAM</option>
                                <option value="19">LAM</option>
                                <option value="20">RF</option>
                                <option value="21">CF</option>
                                <option value="22">LF</option>
                                <option value="23">RW</option>
                                <option value="24">RS</option>
                                <option value="25">ST</option>
                                <option value="26">LS</option>
                                <option value="27">LW</option>
                            </select>
                        </div>
                        <div class="playerSeasons"></div>
                    </div>
                </div>
                <div class="postionBtnWrap">
                    <button class="search">ê²€ìƒ‰</button>
                    <button class="research">ì„ ìˆ˜ë³€ê²½</button>
                </div>
            </div>
            <div class="playerDetailTab hide">
                <div class="positionAndAvg">
                    <div class="selectPostion">í¬ì§€ì…˜ : <span id="spPosition">GK</span></div>
                    <div class="selectAvg">ì´ <span id="matchCount">20</span> ê²½ê¸°í‰ê· </div>
                </div>
                <div class="playerDetailSection">
                    <div class="detailWrap">
                        <div class="chartDetail">ìŠ› : <span id="shoot"></span></div>
                        <div class="chartDetail">ìœ íš¨ ìŠ› : <span id="effectiveShoot"></span></div>
                    </div>
                    <div class="detailWrap">
                        <div class="chartDetail">ì–´ì‹œìŠ¤íŠ¸ : <span id="assist"></span></div>
                        <div class="chartDetail">ë“ì  : <span id="goal"></span></div>
                    </div>
                    <div class="detailWrap">
                        <div class="chartDetail">ë“œë¦¬ë¸” ì‹œë„ : <span id="dribbleTry"></span></div>
                        <div class="chartDetail">
                            ë“œë¦¬ë¸” ì„±ê³µ : <span id="dribbleSuccess"></span>
                        </div>
                    </div>
                    <div class="detailWrap">
                        <div class="chartDetail">íŒ¨ìŠ¤ ì‹œë„ : <span id="passTry"></span></div>
                        <div class="chartDetail">íŒ¨ìŠ¤ ì„±ê³µ : <span id="passSuccess"></span></div>
                    </div>
                    <div class="detailWrap">
                        <div class="chartDetail">ë¸”ë½ ì„±ê³µ : <span id="block"></span></div>
                        <div class="chartDetail">íƒœí´ ì„±ê³µ : <span id="tackle"></span></div>
                    </div>
                    <div>ê°±ì‹  ë‚ ì§œ :<span id="createDate"></span></div>
                    <div>í‰ê·  ì ìˆ˜ :<span id="overallScore"></span></div>
                    <div>í•œì¤„ í‰ :<span id="oneWord"></span></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // ë¦¬ìŠ¤íŠ¸ì— ë§ˆìš°ìŠ¤ í˜¸ë²„í–ˆì„ë•Œ
        $('#playerSearchResult')
            .on('mouseenter', '.player', function () {
                $(this).css({ 'background-color': '#d9d9d9', cursor: 'pointer' });
            })
            .on('mouseleave', '.player', function () {
                $(this).css({ 'background-color': '', cursor: '' });
            });

        // ì‹œì¦Œ í´ë¦­ì‹œ ë¶ˆë“œëŸ¬ì˜´
        $(document).on('click', '.seasonList', function () {
            const playerId = $(this).attr('data-playerId');
            const url = `https://fco.dn.nexoncdn.co.kr/live/externalAssets/common/playersAction/p${playerId}.png`;
            const playerErrorUrl = `
                this.onerror=null; this.src='https://fco.dn.nexoncdn.co.kr/live/externalAssets/common/players/p${parseInt(
                    playerId.slice(3),
                )}.png';
            `;

            $('.playerImg').attr('src', url);
            $('.playerImg').attr('onerror', playerErrorUrl);
            $('.selectPlayerSeason').attr('src', $(this).attr('data-seasonUrl'));

            $('.seasonList').removeClass('selectSeason');
            $('.seasonList').css('filter', 'brightness(0.5)');
            $(this).css('filter', 'brightness(1)');
            $(this).addClass('selectSeason');
        });

        // ê²€ìƒ‰í›„ ë¦¬ìŠ¤íŠ¸ í´ë¦­ì‹œ
        $(document).on('click', '.player', function () {
            const player = $(this).text();
            const playerId = $(this).attr('data-playerid');
            $('#playerSearchResult').empty();
            $('#playerSearchInput').val('');
            $('#playerSearchInput').css('border-radius', ' 15px');
            $('.searchAndResultWrap').addClass('hide');
            $('.selectPlayerWrap').removeClass('hide');

            const url = `https://fco.dn.nexoncdn.co.kr/live/externalAssets/common/playersAction/p${$(
                this,
            ).attr('data-id')}.png`;
            const playerErrorUrl = `
                this.onerror=null; this.src='https://fco.dn.nexoncdn.co.kr/live/externalAssets/common/players/p${playerId}.png';
            `;
            $('.selectPlayerName').text(player);
            $('.playerImg').attr('src', url);
            $('.playerImg').attr('onerror', playerErrorUrl);
            $('.selectPlayerSeason').attr('src', $(this).attr('data-seasonimg'));
            getSeasonImgForPlayer(playerId);
        });

        // ê²€ìƒ‰
        $('.search').click(async function () {
            const selectPosition = $('.playerPosition').val();
            const selectPlayer = $('.selectSeason').attr('data-playerid');

            if (!selectPlayer) {
                showModal('ì‹œì¦Œì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }

            await getDetail(selectPlayer, selectPosition);
        });

        // ì¬ê²€ìƒ‰
        $('.research').click(function () {
            $('.selectPlayerWrap').addClass('hide');
            $('.playerDetailTab').addClass('hide');
            $('.searchAndResultWrap').removeClass('hide');
        });

        const handlePlayerSearch = function () {
            const playerName = $(this).val();

            $.ajax({
                url: `/api/nexon/search/player/${playerName}`,
                type: 'GET',
                success: function (data) {
                    let list = '';
                    if (data.length > 0) {
                        data.map((player) => {
                            list += `<li class="player" 
                            data-id=${player.season_id + player.player_id} 
                            data-playerid=${player.player_id} 
                            data-seasonimg=${player.Season.img}
                            >${player.playerName}</li>`;
                        });

                        $('#playerSearchResult').html(list);
                        $('#playerSearchInput').css('border-radius', ' 15px 15px 0 0');
                    } else {
                        list = `<li class="player">ê²€ìƒ‰ëœ ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤</li>`;

                        $('#playerSearchResult').html(list);
                        $('#playerSearchInput').css('border-radius', ' 15px 15px 0 0');
                    }
                },
                error: function (error) {
                    let list = '';
                    list = `<li class="player">ê²€ìƒ‰ëœ ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤</li>`;

                    $('#playerSearchResult').html(list);
                    $('#playerSearchInput').css('border-radius', ' 15px 15px 0 0');
                },
            });
        };

        $('#playerSearchInput').on('input', debounce(300, handlePlayerSearch));
    });

    async function getSeasonImgForPlayer(player) {
        $.ajax({
            url: `/api/nexon/search/player/season/${player}`,
            type: 'GET',
            beforeSend: function () {
                showLoading();
            },
            complete: function () {
                hideLoading();
            },
            success: async function (data) {
                let list = '';
                if (data) {
                    data.map((season) => {
                        list += `
                            <img src="${
                                season.Season.img
                            }" alt="" class="seasonList" loading="lazy" onerror="" data-seasonUrl="${
                            season.Season.img
                        }" data-playerId="${season.season_id + season.player_id}"/>
                        `;
                    });
                }
                $('.playerSeasons').html(list);
            },
            error: function (err) {
                showModal(err.responseJSON.message);
            },
        });
    }

    // ê²€ìƒ‰ëœ ì„ ìˆ˜ Detail ê°€ì ¸ì˜¤ê¸°
    async function getDetail(player, position) {
        $.ajax({
            url: `/api/nexon/search/player/detail`,
            type: 'GET',
            data: { player, position },
            beforeSend: function () {
                showLoading();
            },
            complete: function () {
                hideLoading();
            },
            success: async function (data) {
                const positionWeights = {
                    defense: {
                        // ìˆ˜ë¹„ìˆ˜
                        dribble: 0.1, // íƒˆì••ë°• ëŠ¥ë ¥
                        pass: 0.2, // ë¹Œë“œì—… íŒ¨ìŠ¤
                        shot: 0.1, // ì••ë°• ì‹œ ìŠˆíŒ…ê¹Œì§€ ì—°ê²°
                        tackle: 0.6, // íƒœí´/ì°¨ë‹¨ ëŠ¥ë ¥
                    },
                    midfield: {
                        // ë¯¸ë“œí•„ë”
                        dribble: 0.25, // ì••ë°• ëŒíŒŒ
                        pass: 0.5, // ê²½ê¸° ì¡°ìœ¨ íŒ¨ìŠ¤
                        shot: 0.15, // ì¤‘ê±°ë¦¬ ìŠˆíŒ…Â·ìœ íš¨ ìŠˆíŒ…
                        tackle: 0.1, // ìˆ˜ë¹„ ê¸°ì—¬ë„
                    },
                    attack: {
                        // ê³µê²©ìˆ˜
                        dribble: 0.3, // 1ëŒ€1 ìƒí™© ëŒíŒŒ
                        pass: 0.2, // ê²°ì •ì  íŒ¨ìŠ¤
                        shot: 0.5, // ê³¨ ê²°ì •ë ¥Â·ìœ íš¨ ìŠˆíŒ…
                        // â€» ìˆ˜ë¹„ contributionì€ ê±°ì˜ ì—†ìœ¼ë¯€ë¡œ tackle ì œì™¸
                    },
                };

                if (data.length > 0) {
                    const dribbleSuccess = Math.round(data[0].status.dribbleSuccess * 100) / 100;
                    const dribbleTry = Math.round(data[0].status.dribbleTry * 100) / 100;
                    const passSuccess = Math.round(data[0].status.passSuccess * 100) / 100;
                    const passTry = Math.round(data[0].status.passTry * 100) / 100;
                    const effectiveShoot = Math.round(data[0].status.effectiveShoot * 100) / 100;
                    const shoot = Math.round(data[0].status.shoot * 100) / 100;
                    const tacklePerMatch = Math.round(data[0].status.tackle * 100) / 100;

                    $('#assist').text(Math.round(data[0].status.assist * 100) / 100);
                    $('#block').text(Math.round(data[0].status.block * 100) / 100);
                    $('#dribble').text(Math.round(data[0].status.dribble * 100) / 100);
                    $('#dribbleSuccess').text(dribbleSuccess);
                    $('#dribbleTry').text(dribbleTry);
                    $('#effectiveShoot').text(effectiveShoot);
                    $('#goal').text(Math.round(data[0].status.goal * 100) / 100);
                    $('#matchCount').text(Math.round(data[0].status.matchCount * 100) / 100);
                    $('#passSuccess').text(passSuccess);
                    $('#passTry').text(passTry);
                    $('#shoot').text(shoot);
                    $('#tackle').text(Math.round(data[0].status.tackle * 100) / 100);
                    $('#createDate').text(dayjs(data[0].createDate).format('YYYY-MM-DD'));
                    $('#spPosition').text(data[0].spPosition);

                    const dribbleRate = dribbleSuccess / dribbleTry;
                    const passRate = passSuccess / passTry;
                    const shotRate = effectiveShoot / shoot;
                    const tackleRate = Math.min(tacklePerMatch / 3, 1);

                    // 4) ì ìˆ˜ ê³„ì‚° í•¨ìˆ˜
                    function calcScore(rates, weights) {
                        let sum = 0;
                        if (weights.dribble) sum += rates.dribble * weights.dribble;
                        if (weights.pass) sum += rates.pass * weights.pass;
                        if (weights.shot) sum += rates.shot * weights.shot;
                        if (weights.tackle) sum += rates.tackle * weights.tackle;
                        return (sum * 10).toFixed(2); // 0~1 â†’ 0~10, ì†Œìˆ˜ ë‘˜ì§¸ìë¦¬ê¹Œì§€
                    }

                    // 5) ê° í¬ì§€ì…˜ë³„ ì ìˆ˜
                    const rates = {
                        dribble: dribbleRate,
                        pass: passRate,
                        shot: shotRate,
                        tackle: tackleRate,
                    };
                    const defScore = parseFloat(calcScore(rates, positionWeights.defense)) || 0;
                    const midScore = parseFloat(calcScore(rates, positionWeights.midfield)) || 0;
                    const attScore = parseFloat(calcScore(rates, positionWeights.attack)) || 0;

                    console.log(defScore);
                    console.log(midScore);
                    console.log(attScore);
                    const overallScore = ((defScore + midScore + attScore) / 3).toFixed(2) || 0;
                    $('#overallScore').text(overallScore || 0);

                    // 1) ì ìˆ˜ ë²”ìœ„ì— ë”°ë¼ ë‹¨ê³„ êµ¬ë¶„
                    function getTier(score) {
                        if (score < 4.5) return 'poor'; // 0~3.99 : ë³„ë¡œ
                        if (score < 6.5) return 'average'; // 4~6.99 : ê·¸ì €ê·¸ëŸ°
                        return 'excellent'; // 7~10   : ë„ˆë¬´ ì¢‹ì€
                    }

                    // 2) ë‹¨ê³„ë³„ ë¬¸êµ¬ ëª©ë¡
                    const messages = {
                        poor: [
                            'ì•„ì§ ë©€ì—ˆì–´ìš”...ğŸ˜…',
                            'ì»¨ë””ì…˜ ë‚œì¡°ì¸ê°€ìš”?',
                            'ë‹¤ìŒì—” ë” ë‚ ì•„ë´…ì‹œë‹¤!',
                            'ì•„ì‰¬ì›€ì´ ë‚¨ëŠ” ê²½ê¸°ë ¥...',
                        ],
                        average: [
                            'ê·¸ì €ê·¸ëŸ° í‰íƒ€!',
                            'ë¬´ë‚œë¬´ë‚œ ê·¸ ìì²´ğŸ‘',
                            'í‰ë²”í•¨ì˜ ë¯¸í•™?',
                            'ì‚´ì§ ì•„ì‰¬ì›€ì´ ë‚¨ë„¤ìš”',
                        ],
                        excellent: [
                            'ì›”ë“œ í´ë˜ìŠ¤!ğŸŒŸ',
                            'ë ˆì „ë“œê¸‰ í¼í¬ë¨¼ìŠ¤!',
                            'ê²½ì´ë¡œìš´ ê²½ê¸°ë ¥!',
                            'ìµœê³ ì˜ ìˆœê°„ì„ ë³´ì—¬ì¤¬ì–´ìš”!',
                        ],
                    };

                    // 3) ë¬´ì‘ìœ„ ë¬¸êµ¬ ë½‘ê¸°
                    function randomMessage(tier) {
                        const arr = messages[tier];
                        return arr[Math.floor(Math.random() * arr.length)];
                    }

                    // 4) ì‹¤ì œ ì‚¬ìš© ì˜ˆì‹œ
                    const tier = getTier(overallScore);
                    const phrase = randomMessage(tier);

                    $('#oneWord').text(phrase);
                    $('.playerSelectTab').css({ 'border-radius': '15px 0 0 15px', margin: '0' });
                    $('.playerDetailTab').removeClass('hide');
                }
            },
            error: function (err) {
                $('.playerDetailTab').addClass('hide');
                $('.playerSelectTab').css({ 'border-radius': '15px', margin: '0' });
                showModal(err.responseJSON.message);
            },
        });
    }
</script>
